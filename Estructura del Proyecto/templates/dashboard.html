{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Parking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <h1 class="mb-4 text-primary"><i class="bi bi-speedometer2 me-2"></i> Dashboard</h1>

  <!-- Tarjetas -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body">
          <h6 class="text-secondary">Placas Registradas</h6>
          <h3 class="fw-bold text-primary">{{ total_placas }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body">
          <h6 class="text-secondary">Últimas Placas</h6>
          <h3 class="fw-bold text-success">{{ ultimas_placas|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body">
          <h6 class="text-secondary">Pagos Realizados</h6>
          <h3 class="fw-bold text-warning">{{ total_pagos }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body">
          <h6 class="text-secondary">Notificaciones</h6>
          <h3 class="fw-bold text-danger">{{ total_notificaciones }}</h3>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body">
          <h6 class="text-secondary">Backups</h6>
          <h3 class="fw-bold text-info">{{ total_backups }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Últimas placas -->
  <h4 class="mt-4">Últimas 5 placas</h4>
  <div class="table-responsive shadow-sm">
    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>Placa</th>
          <th>Fecha y hora</th>
        </tr>
      </thead>
      <tbody>
        {% for u in ultimas_placas %}
        <tr>
          <td>{{ u.numero }}</td>
          <td>{{ u.fecha_hora }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Últimos pagos -->
  <h4 class="mt-5">Últimos 5 pagos</h4>
  <div class="table-responsive shadow-sm">
    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Monto</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for p in ultimos_pagos %}
        <tr>
          <td>{{ p.id }}</td>
          <td>S/. {{ p.monto }}</td>
          <td>{{ p.fecha_hora }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Gráfico -->
  <h4 class="mt-5">Registros de placas por día</h4>
  <div class="card shadow-sm p-3">
    <canvas id="grafico" height="100"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('grafico').getContext('2d');
  const etiquetas = {{ fechas_json|safe }};
  const datos = {{ cantidades_json|safe }};
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: etiquetas,
      datasets: [{
        label: 'Registros de placas',
        data: datos,
        borderWidth: 1,
        backgroundColor: 'rgba(54,162,235,0.5)',
        borderColor: 'rgba(54,162,235,1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
</script>
{% endblock %}
